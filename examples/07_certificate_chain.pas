program certificate_chain;

{$mode objfpc}{$H+}

{ ============================================================================
  ç¤ºä¾‹ 7: è¯ä¹¦é“¾éªŒè¯ï¼ˆæ¦‚å¿µæ¼”ç¤ºï¼‰
  
  åŠŸèƒ½ï¼šæ¼”ç¤ºè¯ä¹¦é“¾çš„æ¦‚å¿µå’ŒéªŒè¯æµç¨‹
  ç”¨é€”ï¼šç†è§£ X.509 è¯ä¹¦é“¾ã€ä¿¡ä»»é”šç‚¹å’Œè¯ä¹¦éªŒè¯
  
  è¯ä¹¦é“¾ç»“æ„ï¼š
    Root CA (æ ¹è¯ä¹¦é¢å‘æœºæ„)
      â†“
    Intermediate CA (ä¸­é—´è¯ä¹¦é¢å‘æœºæ„)
      â†“
    End-Entity Certificate (æœ€ç»ˆå®ä½“è¯ä¹¦ / æœåŠ¡å™¨è¯ä¹¦)
  
  ç¼–è¯‘ï¼šfpc -Fusrc -Fusrc/openssl 07_certificate_chain.pas
  è¿è¡Œï¼š07_certificate_chain
  ============================================================================ }

uses
  SysUtils,
  fafafa.ssl.types,
  fafafa.ssl.factory,
  fafafa.ssl.abstract.intf,
  fafafa.ssl.abstract.types;

procedure ExplainCertificateChain;
begin
  WriteLn('[1/4] è¯ä¹¦é“¾çš„æ¦‚å¿µ');
  WriteLn;
  WriteLn('  ä»€ä¹ˆæ˜¯è¯ä¹¦é“¾ï¼Ÿ');
  WriteLn('  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
  WriteLn('  è¯ä¹¦é“¾æ˜¯ä¸€ç³»åˆ—æ•°å­—è¯ä¹¦çš„å±‚çº§ç»“æ„ï¼Œç”¨äºéªŒè¯èº«ä»½çš„å¯ä¿¡åº¦ã€‚');
  WriteLn;
  WriteLn('  å…¸å‹çš„è¯ä¹¦é“¾ç»“æ„ï¼š');
  WriteLn;
  WriteLn('    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”');
  WriteLn('    â”‚  Root CA æ ¹è¯ä¹¦é¢å‘æœºæ„       â”‚  â† è‡ªç­¾åï¼Œè¢«æ“ä½œç³»ç»Ÿä¿¡ä»»');
  WriteLn('    â”‚  (ä¾‹å¦‚: DigiCert Root CA)    â”‚');
  WriteLn('    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜');
  WriteLn('                   â”‚ ç­¾å');
  WriteLn('                   â†“');
  WriteLn('    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”');
  WriteLn('    â”‚  Intermediate CA ä¸­é—´ CA     â”‚  â† ç”± Root CA ç­¾å');
  WriteLn('    â”‚  (ä¾‹å¦‚: DigiCert TLS CA)     â”‚');
  WriteLn('    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜');
  WriteLn('                   â”‚ ç­¾å');
  WriteLn('                   â†“');
  WriteLn('    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”');
  WriteLn('    â”‚  End-Entity Certificate     â”‚  â† ç”± Intermediate CA ç­¾å');
  WriteLn('    â”‚  (ä¾‹å¦‚: www.example.com)    â”‚     è¿™æ˜¯æœåŠ¡å™¨ä½¿ç”¨çš„è¯ä¹¦');
  WriteLn('    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜');
  WriteLn;
  WriteLn('  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
  WriteLn;
end;

procedure ExplainTrustAnchor;
begin
  WriteLn('[2/4] ä¿¡ä»»é”šç‚¹ï¼ˆTrust Anchorï¼‰');
  WriteLn;
  WriteLn('  ä»€ä¹ˆæ˜¯ä¿¡ä»»é”šç‚¹ï¼Ÿ');
  WriteLn('  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€');
  WriteLn('  ä¿¡ä»»é”šç‚¹æ˜¯è¯ä¹¦é“¾éªŒè¯çš„èµ·ç‚¹ï¼Œé€šå¸¸æ˜¯ Root CA è¯ä¹¦ã€‚');
  WriteLn;
  WriteLn('  æ“ä½œç³»ç»Ÿé¢„è£…çš„æ ¹è¯ä¹¦å­˜å‚¨ä½ç½®ï¼š');
  WriteLn;
  WriteLn('    Windows:');
  WriteLn('      - è¯ä¹¦ç®¡ç†å™¨: certmgr.msc');
  WriteLn('      - å—ä¿¡ä»»çš„æ ¹è¯ä¹¦é¢å‘æœºæ„');
  WriteLn('      - é€šå¸¸æœ‰ 100+ ä¸ªé¢„è£…çš„æ ¹è¯ä¹¦');
  WriteLn;
  WriteLn('    Linux:');
  WriteLn('      - /etc/ssl/certs/ca-certificates.crt');
  WriteLn('      - /etc/ssl/certs/ ç›®å½•');
  WriteLn('      - ç”± ca-certificates åŒ…ç®¡ç†');
  WriteLn;
  WriteLn('    macOS:');
  WriteLn('      - Keychain Access é’¥åŒ™ä¸²è®¿é—®');
  WriteLn('      - ç³»ç»Ÿæ ¹è¯ä¹¦');
  WriteLn;
  WriteLn('  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€');
  WriteLn;
end;

procedure ExplainVerificationProcess;
begin
  WriteLn('[3/4] è¯ä¹¦éªŒè¯æµç¨‹');
  WriteLn;
  WriteLn('  å¦‚ä½•éªŒè¯è¯ä¹¦é“¾ï¼Ÿ');
  WriteLn('  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
  WriteLn;
  WriteLn('  æ­¥éª¤ 1: è·å–æœåŠ¡å™¨è¯ä¹¦');
  WriteLn('    - å®¢æˆ·ç«¯è¿æ¥åˆ°æœåŠ¡å™¨ï¼ˆä¾‹å¦‚ https://www.example.comï¼‰');
  WriteLn('    - æœåŠ¡å™¨å‘é€å…¶è¯ä¹¦å’Œä¸­é—´è¯ä¹¦é“¾');
  WriteLn;
  WriteLn('  æ­¥éª¤ 2: æ„å»ºè¯ä¹¦é“¾');
  WriteLn('    - ä»æœåŠ¡å™¨è¯ä¹¦å¼€å§‹');
  WriteLn('    - æ‰¾åˆ°ç­¾åæ­¤è¯ä¹¦çš„ä¸­é—´ CA');
  WriteLn('    - ç»§ç»­å‘ä¸Šï¼Œç›´åˆ°æ‰¾åˆ°æ ¹ CA');
  WriteLn;
  WriteLn('  æ­¥éª¤ 3: éªŒè¯æ¯ä¸ªè¯ä¹¦');
  WriteLn('    - âœ“ ç­¾åéªŒè¯ï¼šä½¿ç”¨ä¸Šçº§è¯ä¹¦çš„å…¬é’¥éªŒè¯ç­¾å');
  WriteLn('    - âœ“ æœ‰æ•ˆæœŸæ£€æŸ¥ï¼šè¯ä¹¦æ˜¯å¦åœ¨æœ‰æ•ˆæœŸå†…');
  WriteLn('    - âœ“ åŠé”€æ£€æŸ¥ï¼šè¯ä¹¦æ˜¯å¦è¢«åŠé”€ (CRL/OCSP)');
  WriteLn('    - âœ“ ç”¨é€”æ£€æŸ¥ï¼šè¯ä¹¦ç”¨é€”æ˜¯å¦åŒ¹é…ï¼ˆæœåŠ¡å™¨è®¤è¯ï¼‰');
  WriteLn('    - âœ“ ä¸»æœºåéªŒè¯ï¼šè¯ä¹¦ä¸»é¢˜æ˜¯å¦åŒ¹é…åŸŸå');
  WriteLn;
  WriteLn('  æ­¥éª¤ 4: ä¿¡ä»»éªŒè¯');
  WriteLn('    - æ ¹ CA æ˜¯å¦åœ¨ä¿¡ä»»å­˜å‚¨ä¸­ï¼Ÿ');
  WriteLn('    - å¦‚æœæ˜¯ â†’ éªŒè¯é€šè¿‡ âœ“');
  WriteLn('    - å¦‚æœå¦ â†’ éªŒè¯å¤±è´¥ âœ—');
  WriteLn;
  WriteLn('  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
  WriteLn;
end;

procedure DemonstrateWithFafafaSSL;
var
  LLib: ISSLLibrary;
  LContext: ISSLContext;
begin
  WriteLn('[4/4] ä½¿ç”¨ fafafa.ssl è¿›è¡Œè¯ä¹¦éªŒè¯');
  WriteLn;
  
  // åˆå§‹åŒ– SSL åº“
  WriteLn('  1. åˆå§‹åŒ– SSL åº“...');
  LLib := CreateSSLLibrary(sslOpenSSL);
  if not LLib.Initialize then
  begin
    WriteLn('     âœ— æ— æ³•åˆå§‹åŒ– SSL åº“');
    Exit;
  end;
  
  WriteLn('     âœ“ SSL åº“åˆå§‹åŒ–æˆåŠŸ');
  WriteLn('     ç‰ˆæœ¬: ', LLib.GetVersionString);
  WriteLn;
  
  try
    // åˆ›å»º SSL ä¸Šä¸‹æ–‡
    WriteLn('  2. åˆ›å»º SSL ä¸Šä¸‹æ–‡...');
    LContext := LLib.CreateContext(sslCtxClient);
    WriteLn('     âœ“ ä¸Šä¸‹æ–‡åˆ›å»ºæˆåŠŸ');
    WriteLn;
    
    // é…ç½®è¯ä¹¦éªŒè¯
    WriteLn('  3. é…ç½®è¯ä¹¦éªŒè¯å‚æ•°...');
    LContext.SetVerifyMode([sslVerifyPeer]);  // å¯ç”¨å¯¹ç«¯éªŒè¯
    WriteLn('     âœ“ å¯ç”¨å¯¹ç«¯è¯ä¹¦éªŒè¯');
    WriteLn('     âœ“ è‡ªåŠ¨åŠ è½½ç³»ç»Ÿæ ¹è¯ä¹¦å­˜å‚¨');
    WriteLn;
    
    // è®¾ç½®éªŒè¯æ·±åº¦
    WriteLn('  4. è®¾ç½®è¯ä¹¦é“¾éªŒè¯æ·±åº¦...');
    LContext.SetVerifyDepth(10);  // æœ€å¤šéªŒè¯ 10 çº§è¯ä¹¦é“¾
    WriteLn('     âœ“ éªŒè¯æ·±åº¦: 10 çº§');
    WriteLn('     (å¤§å¤šæ•°è¯ä¹¦é“¾æ·±åº¦ä¸º 2-3 çº§)');
    WriteLn;
    
    WriteLn('  5. å‡†å¤‡å°±ç»ªï¼');
    WriteLn;
    WriteLn('     æ­¤ SSL ä¸Šä¸‹æ–‡å·²é…ç½®å¥½è¯ä¹¦éªŒè¯åŠŸèƒ½ã€‚');
    WriteLn('     å½“å»ºç«‹ TLS è¿æ¥æ—¶ï¼Œfafafa.ssl å°†è‡ªåŠ¨ï¼š');
    WriteLn('       â€¢ è·å–æœåŠ¡å™¨è¯ä¹¦å’Œä¸­é—´è¯ä¹¦');
    WriteLn('       â€¢ æ„å»ºå®Œæ•´çš„è¯ä¹¦é“¾');
    WriteLn('       â€¢ éªŒè¯æ¯ä¸ªè¯ä¹¦çš„ç­¾å');
    WriteLn('       â€¢ æ£€æŸ¥è¯ä¹¦æœ‰æ•ˆæœŸ');
    WriteLn('       â€¢ éªŒè¯ä¸»æœºååŒ¹é…');
    WriteLn('       â€¢ ç¡®è®¤æ ¹ CA åœ¨ä¿¡ä»»å­˜å‚¨ä¸­');
    WriteLn;
    
  finally
    LLib.Finalize;
  end;
end;

procedure ExplainCommonIssues;
begin
  WriteLn('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
  WriteLn('  âš ï¸ å¸¸è§è¯ä¹¦éªŒè¯é—®é¢˜');
  WriteLn('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
  WriteLn;
  WriteLn('  é—®é¢˜ 1: è¯ä¹¦è¿‡æœŸ');
  WriteLn('    ç°è±¡: "certificate has expired"');
  WriteLn('    åŸå› : è¯ä¹¦å·²è¶…è¿‡æœ‰æ•ˆæœŸ');
  WriteLn('    è§£å†³: æœåŠ¡å™¨éœ€è¦ç»­æœŸè¯ä¹¦');
  WriteLn;
  WriteLn('  é—®é¢˜ 2: è‡ªç­¾åè¯ä¹¦');
  WriteLn('    ç°è±¡: "self signed certificate"');
  WriteLn('    åŸå› : è¯ä¹¦ç”±è‡ªå·±ç­¾åï¼Œä¸åœ¨ä¿¡ä»»å­˜å‚¨ä¸­');
  WriteLn('    è§£å†³: å°†æ ¹è¯ä¹¦æ·»åŠ åˆ°ä¿¡ä»»å­˜å‚¨ï¼Œæˆ–ä»…ç”¨äºå¼€å‘ç¯å¢ƒ');
  WriteLn;
  WriteLn('  é—®é¢˜ 3: ä¸»æœºåä¸åŒ¹é…');
  WriteLn('    ç°è±¡: "Hostname mismatch"');
  WriteLn('    åŸå› : è¯ä¹¦çš„ CN/SAN ä¸å®é™…åŸŸåä¸ç¬¦');
  WriteLn('    è§£å†³: ä½¿ç”¨æ­£ç¡®çš„åŸŸåï¼Œæˆ–ä¸ºæ‰€æœ‰åŸŸåç”³è¯·è¯ä¹¦');
  WriteLn;
  WriteLn('  é—®é¢˜ 4: ä¸­é—´è¯ä¹¦ç¼ºå¤±');
  WriteLn('    ç°è±¡: "unable to get local issuer certificate"');
  WriteLn('    åŸå› : æœåŠ¡å™¨æœªå‘é€å®Œæ•´çš„è¯ä¹¦é“¾');
  WriteLn('    è§£å†³: æœåŠ¡å™¨é…ç½®éœ€åŒ…å«ä¸­é—´è¯ä¹¦');
  WriteLn;
  WriteLn('  é—®é¢˜ 5: æ ¹è¯ä¹¦ä¸å—ä¿¡ä»»');
  WriteLn('    ç°è±¡: "certificate verify failed"');
  WriteLn('    åŸå› : æ ¹ CA ä¸åœ¨ç³»ç»Ÿä¿¡ä»»å­˜å‚¨ä¸­');
  WriteLn('    è§£å†³: æ›´æ–°ç³»ç»Ÿæ ¹è¯ä¹¦ï¼Œæˆ–æ‰‹åŠ¨æ·»åŠ ');
  WriteLn;
  WriteLn('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
  WriteLn;
end;

begin
  WriteLn('================================================================================');
  WriteLn('  ç¤ºä¾‹ 7: è¯ä¹¦é“¾éªŒè¯ï¼ˆæ¦‚å¿µæ¼”ç¤ºï¼‰');
  WriteLn('  ç†è§£ X.509 è¯ä¹¦é“¾å’ŒéªŒè¯æµç¨‹');
  WriteLn('================================================================================');
  WriteLn;
  
  try
    ExplainCertificateChain;
    ExplainTrustAnchor;
    ExplainVerificationProcess;
    DemonstrateWithFafafaSSL;
    ExplainCommonIssues;
    
    WriteLn('================================================================================');
    WriteLn('  âœ“ ç¤ºä¾‹æ‰§è¡Œå®Œæˆï¼');
    WriteLn('================================================================================');
    WriteLn;
    WriteLn('ğŸ’¡ å­¦åˆ°çš„çŸ¥è¯†ï¼š');
    WriteLn('  1. è¯ä¹¦é“¾çš„å±‚çº§ç»“æ„ï¼ˆRoot CA â†’ Intermediate CA â†’ End-Entityï¼‰');
    WriteLn('  2. ä¿¡ä»»é”šç‚¹çš„æ¦‚å¿µå’Œä½ç½®');
    WriteLn('  3. è¯ä¹¦éªŒè¯çš„å®Œæ•´æµç¨‹');
    WriteLn('  4. å¦‚ä½•ä½¿ç”¨ fafafa.ssl é…ç½®è¯ä¹¦éªŒè¯');
    WriteLn('  5. å¸¸è§è¯ä¹¦é—®é¢˜çš„è¯Šæ–­å’Œè§£å†³');
    WriteLn;
    WriteLn('ğŸ”’ å®‰å…¨æœ€ä½³å®è·µï¼š');
    WriteLn('  - å§‹ç»ˆå¯ç”¨è¯ä¹¦éªŒè¯ï¼ˆsslVerifyPeerï¼‰');
    WriteLn('  - å®šæœŸæ›´æ–°ç³»ç»Ÿæ ¹è¯ä¹¦å­˜å‚¨');
    WriteLn('  - æœåŠ¡å™¨åº”å‘é€å®Œæ•´çš„è¯ä¹¦é“¾');
    WriteLn('  - ä½¿ç”¨å—ä¿¡ä»» CA é¢å‘çš„è¯ä¹¦');
    WriteLn('  - ç›‘æ§è¯ä¹¦è¿‡æœŸæ—¶é—´ï¼Œæå‰ç»­æœŸ');
    WriteLn;
    WriteLn('ğŸ“š ä¸‹ä¸€æ­¥ï¼š');
    WriteLn('  - æŸ¥çœ‹ç¤ºä¾‹ 1: TLS å®¢æˆ·ç«¯ (01_tls_client.pas) - åŒ…å«å®é™…è¯ä¹¦éªŒè¯');
    WriteLn('  - æŸ¥çœ‹ç¤ºä¾‹ 2: è¯ä¹¦ç”Ÿæˆ (02_generate_certificate.pas)');
    WriteLn('  - é˜…è¯» docs/SECURITY_GUIDE.md äº†è§£è¯ä¹¦å®‰å…¨');
    WriteLn;
    
    ExitCode := 0;
    
  except
    on E: Exception do
    begin
      WriteLn;
      WriteLn('================================================================================');
      WriteLn('  âœ— é”™è¯¯: ', E.Message);
      WriteLn('================================================================================');
      WriteLn;
      ExitCode := 1;
    end;
  end;
end.

