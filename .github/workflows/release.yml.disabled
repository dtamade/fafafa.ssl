name: ðŸš€ Release Automation

on:
  push:
    tags:
      - 'v*.*.*'        # åŒ¹é… v1.0.0, v1.0.0-rc.1 ç­‰
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to release (e.g., v1.0.0-rc.1)'
        required: true
        type: string

jobs:
  validate-release:
    name: ðŸ” Validate Release
    runs-on: ubuntu-latest
    timeout-minutes: 15

    outputs:
      version: ${{ steps.get-version.outputs.version }}
      is-prerelease: ${{ steps.check-prerelease.outputs.is-prerelease }}

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # èŽ·å–å®Œæ•´åŽ†å²ç”¨äºŽchangelog

      - name: ðŸ·ï¸ Get version
        id: get-version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            VERSION="${{ github.event.inputs.version }}"
          else
            VERSION="${GITHUB_REF#refs/tags/}"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "ðŸ“Œ Release version: $VERSION"

      - name: ðŸ” Check if pre-release
        id: check-prerelease
        run: |
          VERSION="${{ steps.get-version.outputs.version }}"
          if [[ "$VERSION" =~ (rc|alpha|beta) ]]; then
            echo "is-prerelease=true" >> $GITHUB_OUTPUT
            echo "âœ… This is a pre-release"
          else
            echo "is-prerelease=false" >> $GITHUB_OUTPUT
            echo "âœ… This is a stable release"
          fi

      - name: ðŸ“¦ Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y fpc fp-units-fcl python3

      - name: ðŸ”¨ Build and test
        run: |
          chmod +x build_linux.sh
          ./build_linux.sh

  create-release:
    name: ðŸ“¦ Create GitHub Release
    needs: validate-release
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ðŸ“ Generate Release Notes
        id: release-notes
        run: |
          VERSION="${{ needs.validate-release.outputs.version }}"
          
          cat > release_notes.md << 'EOF'
          # fafafa.ssl $VERSION
          
          ## ðŸŽ¯ ä¸»è¦ç‰¹æ€§
          
          - âœ… **å¤šåŽç«¯SSL/TLSæ¡†æž¶**: OpenSSL + WinSSL (Schannel)
          - âœ… **é›¶ä¾èµ–Windowséƒ¨ç½²**: WinSSLåŽç«¯æ— éœ€OpenSSL DLL
          - âœ… **ç»Ÿä¸€æŠ½è±¡æŽ¥å£**: è·¨å¹³å°ä¸€è‡´çš„API
          - âœ… **è‡ªåŠ¨CAåŠ è½½**: OpenSSLè‡ªåŠ¨åŠ è½½ç³»ç»Ÿè¯ä¹¦å­˜å‚¨
          - âœ… **å·¥åŽ‚æ¨¡å¼**: è‡ªåŠ¨æ£€æµ‹æœ€ä½³SSLåº“
          - âœ… **SNIæ”¯æŒ**: å®Œæ•´çš„Server Name Indicationå®žçŽ°
          
          ## ðŸ“¦ åŒ…å«å†…å®¹
          
          ### æ ¸å¿ƒæ¨¡å—
          - `fafafa.ssl.factory` - å·¥åŽ‚æ¨¡å¼å’Œé«˜çº§è¾…åŠ©å‡½æ•°
          - `fafafa.ssl.openssl` - OpenSSL 3.x/1.1.xåŽç«¯
          - `fafafa.ssl.winssl` - Windows SchannelåŽç«¯
          - `fafafa.ssl.utils` - åŠ å¯†å·¥å…·å‡½æ•°ï¼ˆå“ˆå¸Œã€ç¼–ç ç­‰ï¼‰
          
          ### ç¤ºä¾‹ç¨‹åº
          - 7ä¸ªä¼ä¸šçº§ç¤ºä¾‹ï¼ˆ2,500+è¡Œä»£ç ï¼‰
          - è¦†ç›–SSLå®¢æˆ·ç«¯ã€è¯ä¹¦éªŒè¯ã€å¯†é’¥ç”Ÿæˆç­‰åœºæ™¯
          
          ### æ–‡æ¡£
          - Linuxå¿«é€Ÿå¼€å§‹æŒ‡å—
          - FCLä¾èµ–é…ç½®è¯´æ˜Ž
          - APIå‚è€ƒå’Œæž¶æž„æ–‡æ¡£
          
          ## ðŸ”§ ç³»ç»Ÿè¦æ±‚
          
          ### Linux
          - Free Pascal â‰¥ 3.2.0
          - OpenSSL â‰¥ 3.0.0 (æŽ¨è) æˆ– 1.1.1+
          - FCL (fcl-base, fcl-json)
          
          ### Windows
          - Free Pascal â‰¥ 3.2.0
          - OpenSSL 3.x/1.1.x (å¯é€‰ï¼ŒWinSSLæ— éœ€)
          - Windows 10+ (WinSSLåŽç«¯)
          
          ## ðŸ“Š æµ‹è¯•è¦†ç›–
          
          - **ç¼–è¯‘æˆåŠŸçŽ‡**: 100% (75/75 Linux, 88/88 Windows)
          - **æ ¸å¿ƒæµ‹è¯•é€šè¿‡**: 97.5%+
          - **ç¤ºä¾‹ç¨‹åº**: 100% (7/7)
          
          ## ðŸš€ å¿«é€Ÿå¼€å§‹
          
          ### Linux
          ```bash
          git clone https://github.com/yourusername/fafafa.ssl.git
          cd fafafa.ssl
          ./build_linux.sh
          ./run_tests_linux.sh
          ```
          
          ### ä½¿ç”¨å·¥åŽ‚æ¨¡å¼
          ```pascal
          uses fafafa.ssl.factory;
          
          var
            Ctx: ISSLContext;
          begin
            // è‡ªåŠ¨æ£€æµ‹æœ€ä½³åº“ï¼ˆWindowsç”¨WinSSLï¼ŒLinuxç”¨OpenSSLï¼‰
            Ctx := CreateSSLContext(sslCtxClient);
            // ... ä½¿ç”¨ç»Ÿä¸€API
          end.
          ```
          
          ## ðŸ› å·²çŸ¥é™åˆ¶
          
          - WinSSLæœåŠ¡å™¨æ¨¡å¼ä»…åŸºç¡€å®žçŽ°ï¼ˆå®¢æˆ·ç«¯æ¨¡å¼å®Œæ•´ï¼‰
          - éƒ¨åˆ†OpenSSL 1.0.x APIå·²æ ‡è®°ä¸ºåºŸå¼ƒ
          - é«˜çº§OCSPåŠŸèƒ½éœ€è¿›ä¸€æ­¥æµ‹è¯•
          
          ## ðŸ“š æ–‡æ¡£
          
          - [README](README.md) - é¡¹ç›®æ¦‚è¿°
          - [Linuxå¿«é€Ÿå¼€å§‹](docs/LINUX_QUICKSTART.md)
          - [FCLä¾èµ–è¯´æ˜Ž](docs/FCL_DEPENDENCIES.md)
          - [é¡¹ç›®æ„¿æ™¯](PROJECT_VISION.md)
          
          ## ðŸ’¬ æ”¯æŒ
          
          - é—®é¢˜åé¦ˆ: [GitHub Issues](https://github.com/yourusername/fafafa.ssl/issues)
          - è®¨è®ºåŒº: [GitHub Discussions](https://github.com/yourusername/fafafa.ssl/discussions)
          
          ---
          
          **å®Œæ•´æ›´æ–°æ—¥å¿—**: [CHANGELOG.md](CHANGELOG.md)
          EOF
          
          # æ›¿æ¢ç‰ˆæœ¬å·
          sed -i "s/\$VERSION/$VERSION/g" release_notes.md
          
          echo "ðŸ“ Release notes generated"
          cat release_notes.md

      - name: ðŸ“¦ Create source archive
        run: |
          VERSION="${{ needs.validate-release.outputs.version }}"
          ARCHIVE_NAME="fafafa-ssl-${VERSION}-source"
          
          # åˆ›å»ºå½’æ¡£ï¼ˆæŽ’é™¤ä¸å¿…è¦çš„æ–‡ä»¶ï¼‰
          tar -czf "${ARCHIVE_NAME}.tar.gz" \
            --exclude='.git' \
            --exclude='.github' \
            --exclude='tests/bin' \
            --exclude='build' \
            --exclude='out' \
            --exclude='*.o' \
            --exclude='*.ppu' \
            --exclude='*.a' \
            src/ examples/ docs/ scripts/ \
            README.md CLAUDE.md PROJECT_VISION.md \
            fafafa_ssl.lpk \
            build_linux.sh run_tests_linux.sh
          
          echo "ðŸ“¦ Created: ${ARCHIVE_NAME}.tar.gz"
          ls -lh "${ARCHIVE_NAME}.tar.gz"

      - name: ðŸš€ Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          name: fafafa.ssl ${{ needs.validate-release.outputs.version }}
          body_path: release_notes.md
          draft: false
          prerelease: ${{ needs.validate-release.outputs.is-prerelease == 'true' }}
          files: |
            fafafa-ssl-*.tar.gz
          tag_name: ${{ needs.validate-release.outputs.version }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: ðŸ“Š Release summary
        run: |
          echo "## ðŸš€ Release Created" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version**: ${{ needs.validate-release.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "**Type**: ${{ needs.validate-release.outputs.is-prerelease == 'true' && 'Pre-release' || 'Stable' }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“¦ Artifacts" >> $GITHUB_STEP_SUMMARY
          echo "- Source archive: fafafa-ssl-${{ needs.validate-release.outputs.version }}-source.tar.gz" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ”— Links" >> $GITHUB_STEP_SUMMARY
          echo "- [Release Page](https://github.com/${{ github.repository }}/releases/tag/${{ needs.validate-release.outputs.version }})" >> $GITHUB_STEP_SUMMARY
          echo "- [Download Source](https://github.com/${{ github.repository }}/archive/${{ needs.validate-release.outputs.version }}.tar.gz)" >> $GITHUB_STEP_SUMMARY

