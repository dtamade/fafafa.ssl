# 实现计划: WinSSL 服务端支持

## 概述

本实现计划将 WinSSL 后端的服务端 TLS 握手和连接管理功能从 10% 完成度提升到完全可用状态。实现将采用 TDD (测试驱动开发) 方法,先编写测试,再实现功能,确保代码质量和正确性。

实现语言: **Pascal (Free Pascal/Delphi)**

## 任务列表

### 阶段 1: 基础服务端握手 (核心功能)

- [x] 1. 设置测试基础设施
  - 创建测试证书和密钥对(用于测试)
  - 设置 FPCUnit 测试项目结构
  - 创建测试辅助函数(证书加载、连接模拟等)
  - _需求: 所有测试需求的基础_

- [x] 2. 实现服务端上下文初始化
  - [x] 2.1 增强 TWinSSLContext.EnsureCredentialsAcquired 支持服务端模式
    - 检测 FContextType 是否为 sslCtxServer
    - 设置 dwDirection := SECPKG_CRED_INBOUND
    - 配置 SchannelCred 结构包含服务器证书
    - 调用 AcquireCredentialsHandle 获取服务端凭据
    - _需求: 1.1, 1.2, 1.3, 1.4, 1.5_
  
  - [ ]* 2.2 编写属性测试: 配置往返一致性 (属性 1)
    - **属性 1: 上下文配置往返一致性**
    - **验证需求: 1.3, 1.4, 1.5**
    - 生成随机的 TLS 版本、密码套件和验证模式组合
    - 设置到上下文后读取,验证值一致
    - 运行 100 次迭代
  
  - [ ]* 2.3 编写属性测试: 证书加载幂等性 (属性 2)
    - **属性 2: 证书加载幂等性**
    - **验证需求: 1.1, 1.2, 9.1, 9.2**
    - 多次加载相同证书,验证证书指纹一致
    - 测试 PFX 文件和证书存储两种方式
    - 运行 100 次迭代
  
  - [ ]* 2.4 编写属性测试: 无效输入错误处理 (属性 3)
    - **属性 3: 无效输入错误处理**
    - **验证需求: 1.6, 9.7**
    - 生成各种无效输入(不存在的文件、损坏数据、无私钥证书)
    - 验证返回明确错误而不是崩溃
    - 运行 100 次迭代


- [x] 3. 实现服务端 TLS 握手核心逻辑
  - [x] 3.1 实现 TWinSSLConnection.ServerHandshake 方法
    - 初始化握手状态为 sslHsInProgress
    - 实现握手消息处理循环
    - 调用 AcceptSecurityContext API 处理握手
    - 处理 SEC_I_CONTINUE_NEEDED 状态(需要更多数据)
    - 处理 SEC_E_INCOMPLETE_MESSAGE 状态(消息不完整)
    - 处理 SECBUFFER_EXTRA 类型的额外数据
    - 发送服务端响应消息到客户端
    - _需求: 2.1, 2.2, 2.3, 2.5, 2.8_
  
  - [x] 3.2 实现 TWinSSLConnection.Accept 方法
    - 调用 ServerHandshake 执行握手
    - 握手成功后设置 FConnected := True
    - 设置 FHandshakeState := sslHsCompleted
    - 返回握手结果
    - _需求: 2.5_
  
  - [ ]* 3.3 编写属性测试: 握手消息序列正确性 (属性 4)
    - **属性 4: 握手消息序列正确性**
    - **验证需求: 2.1, 2.2, 2.3, 2.5**
    - 模拟客户端发送各种 Hello 消息
    - 验证服务端响应的消息类型和顺序符合 TLS 规范
    - 运行 100 次迭代
  
  - [ ]* 3.4 编写属性测试: 握手分片处理正确性 (属性 6)
    - **属性 6: 握手分片处理正确性**
    - **验证需求: 2.8**
    - 生成完整握手消息,以不同方式分片发送
    - 验证握手结果一致
    - 运行 100 次迭代

- [x] 4. 实现握手错误处理
  - [x] 4.1 实现 Schannel 错误码到 SSL 错误的映射
    - 创建错误码映射表
    - 实现 MapSchannelError 函数
    - 为每个错误类型生成用户友好的消息
    - _需求: 2.4, 7.1, 7.2, 7.6_
  
  - [x] 4.2 在握手流程中集成错误处理
    - 捕获 AcceptSecurityContext 返回的错误
    - 根据错误类型抛出相应的异常
    - 发送 TLS 警报消息(如果适用)
    - _需求: 2.4, 2.7_
  
  - [ ]* 4.3 编写属性测试: 握手错误警报一致性 (属性 5)
    - **属性 5: 握手错误警报一致性**
    - **验证需求: 2.4**
    - 触发各种握手错误(协议不匹配、无共同密码套件)
    - 验证发送的 TLS 警报类型正确
    - 运行 100 次迭代
  
  - [ ]* 4.4 编写属性测试: 错误信息完整性 (属性 19)
    - **属性 19: 错误信息完整性**
    - **验证需求: 7.1, 7.2**
    - 触发各种错误
    - 验证错误对象包含错误类型、错误代码和描述性消息
    - 运行 100 次迭代

- [x] 5. 检查点 - 基础握手功能验证
  - 确保所有测试通过
  - 使用 OpenSSL s_client 测试基本连接
  - 如有问题请询问用户


### 阶段 2: 客户端证书验证

- [x] 6. 实现客户端证书验证基础
  - [x] 6.1 实现 TWinSSLConnection.ValidatePeerCertificate 方法
    - 使用 QueryContextAttributesW 获取客户端证书
    - 检查验证模式配置(不验证/可选/必需)
    - 处理无证书情况(根据验证模式)
    - 返回验证结果
    - _需求: 3.1, 3.2, 3.7_
  
  - [x] 6.2 实现证书链验证
    - 使用 CertGetCertificateChain 构建证书链
    - 使用 CertVerifyCertificateChainPolicy 验证证书链
    - 检查证书有效期
    - 检查证书吊销状态(如果配置)
    - _需求: 3.3, 3.4, 3.5_
  
  - [ ]* 6.3 编写属性测试: 客户端证书验证一致性 (属性 7)
    - **属性 7: 客户端证书验证一致性**
    - **验证需求: 3.3, 3.7**
    - 生成各种证书(有效、过期、自签名、吊销)
    - 验证验证结果与证书实际有效性一致
    - 运行 100 次迭代
  
  - [ ]* 6.4 编写属性测试: 验证模式行为正确性 (属性 8)
    - **属性 8: 验证模式行为正确性**
    - **验证需求: 3.1, 3.2**
    - 测试不验证模式: 所有连接被接受
    - 测试可选模式: 有证书时验证,无证书时接受
    - 测试必需模式: 无证书时拒绝,有证书时验证
    - 运行 100 次迭代

- [x] 7. 实现自定义验证回调
  - [x] 7.1 在 TWinSSLContext 中添加验证回调支持
    - 添加 FVerifyCallback 字段
    - 实现 SetVerifyCallback 方法
    - _需求: 3.6_
  
  - [x] 7.2 在 ValidatePeerCertificate 中集成回调
    - 验证失败时调用回调函数
    - 根据回调返回值决定是否继续连接
    - 传递证书信息和错误详情给回调
    - _需求: 3.6_
  
  - [ ]* 7.3 编写属性测试: 验证回调可覆盖性 (属性 9)
    - **属性 9: 验证回调可覆盖性**
    - **验证需求: 3.6**
    - 使用无效证书,设置返回 True 的回调
    - 验证连接成功建立
    - 运行 100 次迭代

- [x] 8. 检查点 - 证书验证功能验证
  - 确保所有测试通过
  - 测试双向 TLS 认证场景
  - 如有问题请询问用户


### 阶段 3: 会话管理

- [x] 9. 实现会话数据结构
  - [x] 9.1 完善 TWinSSLSession 类实现
    - 实现 GetID, IsValid, IsResumable 方法
    - 实现 GetProtocolVersion, GetCipherName 方法
    - 实现 GetPeerCertificate 方法
    - 实现 Clone 方法
    - 实现 SetSessionMetadata 方法
    - _需求: 4.1, 4.2, 4.3_
  
  - [ ]* 9.2 编写单元测试: 会话元数据设置和读取
    - 测试会话 ID 设置和读取
    - 测试协议版本和密码套件设置
    - 测试会话有效性检查
    - _需求: 4.1_

- [x] 10. 实现会话管理器
  - [x] 10.1 实现 TWinSSLSessionManager 类
    - 实现 AddSession 方法(线程安全)
    - 实现 GetSession 方法(线程安全)
    - 实现 RemoveSession 方法(线程安全)
    - 实现 CleanupExpired 方法
    - 配置最大会话数和超时时间
    - _需求: 4.4, 4.5, 4.6, 4.7_
  
  - [ ]* 10.2 编写属性测试: 会话缓存操作正确性 (属性 11)
    - **属性 11: 会话缓存操作正确性**
    - **验证需求: 4.4**
    - 生成随机会话,添加到缓存
    - 通过 ID 检索,验证会话一致性
    - 运行 100 次迭代
  
  - [ ]* 10.3 编写属性测试: 会话配置往返一致性 (属性 12)
    - **属性 12: 会话配置往返一致性**
    - **验证需求: 4.6**
    - 生成随机缓存大小和超时时间
    - 设置后读取,验证值一致
    - 运行 100 次迭代

- [x] 11. 集成会话复用到握手流程
  - [x] 11.1 在 ServerHandshake 中支持会话复用
    - 检查客户端是否请求会话复用
    - 从会话管理器获取会话
    - 验证会话有效性
    - 使用会话快速恢复连接
    - _需求: 4.1, 4.2, 4.3_
  
  - [x] 11.2 在握手完成后保存会话
    - 提取会话信息(ID、协议、密码套件)
    - 创建 TWinSSLSession 对象
    - 添加到会话管理器
    - _需求: 4.4_
  
  - [ ]* 11.3 编写属性测试: 会话复用往返一致性 (属性 10)
    - **属性 10: 会话复用往返一致性**
    - **验证需求: 4.1, 4.2, 4.3**
    - 建立连接,保存会话,关闭连接
    - 使用会话重新连接,验证会话被复用
    - 运行 100 次迭代

- [ ] 12. 检查点 - 会话管理功能验证
  - 确保所有测试通过
  - 测试会话复用性能提升
  - 如有问题请询问用户


### 阶段 4: 数据传输优化

- [ ] 13. 优化数据加密和解密
  - [ ] 13.1 优化 Read 方法实现
    - 优化缓冲区管理(避免不必要的拷贝)
    - 实现流式解密(处理大数据块)
    - 正确处理 TLS 记录层分片
    - 处理部分数据接收情况
    - _需求: 5.2, 5.3, 5.6_
  
  - [ ] 13.2 优化 Write 方法实现
    - 优化缓冲区管理
    - 实现流式加密(处理大数据块)
    - 正确处理 TLS 记录层分片
    - _需求: 5.1, 5.3, 5.6_
  
  - [ ]* 13.3 编写属性测试: 数据加密解密往返一致性 (属性 13)
    - **属性 13: 数据加密解密往返一致性**
    - **验证需求: 5.1, 5.2**
    - 生成随机数据,通过 TLS 连接发送和接收
    - 验证接收数据与发送数据一致
    - 运行 100 次迭代
  
  - [ ]* 13.4 编写属性测试: 数据分片处理正确性 (属性 14)
    - **属性 14: 数据分片处理正确性**
    - **验证需求: 5.3**
    - 生成各种大小的数据
    - 以不同分片大小传输
    - 验证接收数据完整性
    - 运行 100 次迭代

- [ ] 14. 实现数据完整性检测
  - [ ] 14.1 在解密过程中验证数据完整性
    - 检查 DecryptMessage 返回的状态
    - 检测 SEC_E_MESSAGE_ALTERED 错误
    - 检测 SEC_E_DECRYPT_FAILURE 错误
    - 完整性检查失败时终止连接
    - _需求: 5.4, 5.5_
  
  - [ ]* 14.2 编写属性测试: 数据完整性检测 (属性 15)
    - **属性 15: 数据完整性检测**
    - **验证需求: 5.4**
    - 加密数据后随机修改字节
    - 尝试解密,验证检测到篡改
    - 运行 100 次迭代

- [ ] 15. 检查点 - 数据传输功能验证
  - 确保所有测试通过
  - 测试大文件传输
  - 测试性能指标
  - 如有问题请询问用户


### 阶段 5: 接口一致性和错误处理

- [ ] 16. 确保与 OpenSSL 后端的接口一致性
  - [ ] 16.1 验证 ISSLContext 接口实现完整性
    - 检查所有接口方法都已实现
    - 确保方法签名与 OpenSSL 后端一致
    - 确保返回值语义一致
    - _需求: 6.1, 6.2_
  
  - [ ] 16.2 验证 ISSLConnection 接口实现完整性
    - 检查所有接口方法都已实现
    - 确保方法签名与 OpenSSL 后端一致
    - 确保返回值语义一致
    - _需求: 6.1, 6.2_
  
  - [ ]* 16.3 编写属性测试: 配置选项兼容性 (属性 16)
    - **属性 16: 配置选项兼容性**
    - **验证需求: 6.2**
    - 使用 OpenSSL 的配置选项配置 WinSSL
    - 验证不抛出异常
    - 运行 100 次迭代

- [ ] 17. 实现错误代码映射
  - [ ] 17.1 创建 WinSSL 到统一错误代码的映射
    - 映射 Schannel 错误到 TSSLErrorType
    - 确保与 OpenSSL 后端的错误语义一致
    - 为每个错误提供描述性消息
    - _需求: 6.5, 7.1, 7.2, 7.6_
  
  - [ ]* 17.2 编写属性测试: 错误代码映射一致性 (属性 17)
    - **属性 17: 错误代码映射一致性**
    - **验证需求: 6.5**
    - 触发相同的错误情况
    - 比较 WinSSL 和 OpenSSL 的错误代码
    - 验证语义一致
    - 运行 100 次迭代
  
  - [ ]* 17.3 编写属性测试: Schannel 错误转换友好性 (属性 21)
    - **属性 21: Schannel 错误转换友好性**
    - **验证需求: 7.6**
    - 模拟各种 Schannel 错误
    - 验证错误消息的可读性(不包含原始错误码)
    - 运行 100 次迭代

- [ ] 18. 实现证书格式转换
  - [ ] 18.1 实现 PEM 到 DER 格式转换
    - 解析 PEM 格式证书
    - 转换为 DER 格式
    - 加载到 Schannel
    - _需求: 6.6, 9.5_
  
  - [ ]* 18.2 编写属性测试: 证书格式转换正确性 (属性 18)
    - **属性 18: 证书格式转换正确性**
    - **验证需求: 6.6, 9.5**
    - 生成 PEM 证书,转换为 DER
    - 加载后验证证书属性一致
    - 运行 100 次迭代

- [ ] 19. 完善错误处理和诊断
  - [ ] 19.1 实现详细的握手失败诊断
    - 记录握手过程的关键步骤
    - 提供失败原因的详细信息
    - 支持调试模式输出
    - _需求: 7.3, 7.4, 7.5_
  
  - [ ]* 19.2 编写属性测试: 握手失败详情提供 (属性 20)
    - **属性 20: 握手失败详情提供**
    - **验证需求: 7.4**
    - 触发各种握手失败
    - 验证错误消息包含具体原因
    - 运行 100 次迭代

- [ ] 20. 检查点 - 接口一致性验证
  - 确保所有测试通过
  - 运行后端契约测试
  - 如有问题请询问用户


### 阶段 6: 扩展功能和优化

- [ ] 21. 实现证书存储操作
  - [ ] 21.1 实现从 Windows 证书存储加载证书
    - 实现通过指纹查找证书
    - 实现通过主题名称查找证书
    - 从 "My" 存储加载证书
    - 验证证书包含私钥
    - _需求: 1.2, 9.2, 9.3, 9.4, 9.7_
  
  - [ ]* 21.2 编写属性测试: 证书查找正确性 (属性 23)
    - **属性 23: 证书查找正确性**
    - **验证需求: 9.3, 9.4**
    - 在测试证书存储中添加证书
    - 使用指纹和主题名称查找
    - 验证找到正确的证书
    - 运行 100 次迭代

- [ ] 22. 实现 SNI 支持
  - [ ] 22.1 在握手过程中解析 SNI 扩展
    - 从客户端 Hello 中提取 SNI
    - 存储服务器名称
    - 提供 GetServerName 方法
    - _需求: 11.6_
  
  - [ ]* 22.2 编写属性测试: SNI 处理正确性 (属性 24)
    - **属性 24: SNI 处理正确性**
    - **验证需求: 11.6**
    - 发送包含各种 SNI 的客户端 Hello
    - 验证服务端正确解析服务器名称
    - 运行 100 次迭代

- [ ] 23. 实现资源管理和清理
  - [ ] 23.1 确保连接关闭时释放所有资源
    - 释放 Schannel 上下文句柄
    - 释放证书上下文
    - 清理缓冲区
    - 实现析构函数
    - _需求: 8.4_
  
  - [ ] 23.2 实现会话缓存清理
    - 定期清理过期会话
    - 在内存压力下清理会话
    - _需求: 4.7_
  
  - [ ]* 23.3 编写属性测试: 资源清理完整性 (属性 22)
    - **属性 22: 资源清理完整性**
    - **验证需求: 8.4**
    - 建立连接,关闭
    - 使用内存分析工具检查资源释放
    - 运行 100 次迭代

- [ ] 24. 性能优化
  - [ ] 24.1 优化缓冲区大小和管理
    - 调整缓冲区大小为最优值(16KB)
    - 减少内存拷贝
    - 实现缓冲区池(可选)
    - _需求: 8.3_
  
  - [ ] 24.2 优化并发连接处理
    - 确保线程安全
    - 优化锁的使用
    - 测试并发性能
    - _需求: 8.1, 8.6_
  
  - [ ]* 24.3 编写性能测试
    - 测试握手延迟(目标 < 50ms)
    - 测试并发连接数(目标 100+)
    - 测试内存占用(目标 < 100KB/连接)
    - _需求: 8.1, 8.2, 8.3_

- [ ] 25. 检查点 - 扩展功能验证
  - 确保所有测试通过
  - 测试 SNI 功能
  - 测试性能指标
  - 如有问题请询问用户


### 阶段 7: 集成测试和验证

- [ ] 26. 实现与真实客户端的互操作性测试
  - [ ]* 26.1 编写 OpenSSL s_client 集成测试
    - 启动测试服务器
    - 使用 OpenSSL s_client 连接
    - 验证握手成功
    - 验证数据传输正常
    - _需求: 11.3_
  
  - [ ]* 26.2 编写浏览器集成测试
    - 启动 HTTPS 测试服务器
    - 使用自动化工具(如 Selenium)测试浏览器连接
    - 验证 Chrome、Firefox、Edge 都能正常连接
    - _需求: 11.2_
  
  - [ ]* 26.3 编写 HTTP 客户端库集成测试
    - 测试 curl 连接
    - 测试 wget 连接
    - 测试 Python requests 连接
    - 测试 Node.js https 模块连接
    - _需求: 11.3, 11.4_

- [ ] 27. 实现压力测试和稳定性测试
  - [ ]* 27.1 编写并发连接压力测试
    - 同时建立 100+ 个连接
    - 验证所有连接都能成功
    - 验证系统保持稳定
    - _需求: 8.1, 8.6_
  
  - [ ]* 27.2 编写长时间运行测试
    - 运行服务器 24 小时
    - 持续建立和关闭连接
    - 监控内存使用
    - 验证无内存泄漏
    - _需求: 8.5_
  
  - [ ]* 27.3 编写资源耗尽测试
    - 模拟系统资源不足
    - 验证优雅拒绝新连接
    - 验证不会崩溃
    - _需求: 8.7_

- [ ] 28. 实现平台兼容性测试
  - [ ]* 28.1 测试 Windows 10 各版本兼容性
    - 测试 Windows 10 1507-1809 (TLS 1.2)
    - 测试 Windows 10 1903+ (TLS 1.3)
    - 验证协议降级正常工作
    - _需求: 10.1, 10.3_
  
  - [ ]* 28.2 测试 Windows Server 兼容性
    - 测试 Windows Server 2016 (TLS 1.2)
    - 测试 Windows Server 2019+ (TLS 1.3)
    - 验证功能正常
    - _需求: 10.2_
  
  - [ ]* 28.3 测试 Schannel API 功能检测
    - 测试运行时检测 API 可用性
    - 测试不可用功能的错误处理
    - _需求: 10.4, 10.5, 10.6_

- [ ] 29. 最终检查点 - 完整功能验证
  - 确保所有单元测试通过
  - 确保所有属性测试通过
  - 确保所有集成测试通过
  - 运行完整的测试套件
  - 验证代码覆盖率
  - 如有问题请询问用户


### 阶段 8: 文档和示例

- [ ] 30. 创建代码示例
  - [ ] 30.1 编写简单 HTTPS 服务器示例
    - 创建最小化的 HTTPS 服务器
    - 处理 HTTP GET 请求
    - 返回简单的 HTML 响应
    - 添加详细注释
    - _需求: 11.1_
  
  - [ ] 30.2 编写双向 TLS 认证示例
    - 配置客户端证书验证
    - 实现验证回调
    - 展示证书信息提取
    - 添加详细注释
    - _需求: 3.1, 3.2, 3.6_
  
  - [ ] 30.3 编写会话复用示例
    - 展示会话保存和恢复
    - 展示性能提升
    - 添加详细注释
    - _需求: 4.1, 4.2, 4.3_
  
  - [ ] 30.4 编写错误处理示例
    - 展示各种错误场景的处理
    - 展示错误信息提取
    - 展示优雅降级
    - 添加详细注释
    - _需求: 7.1, 7.2, 7.4_

- [ ] 31. 更新文档
  - [ ] 31.1 更新 WINSSL_USER_GUIDE.md
    - 添加服务端使用指南
    - 添加配置说明
    - 添加常见问题解答
    - 添加故障排除指南
  
  - [ ] 31.2 更新 API_REFERENCE.md
    - 添加服务端 API 文档
    - 更新接口说明
    - 添加代码示例
  
  - [ ] 31.3 创建 SECURITY_GUIDE.md
    - 添加服务端安全最佳实践
    - 添加证书管理指南
    - 添加安全配置建议
  
  - [ ] 31.4 创建 MIGRATION_GUIDE.md
    - 添加从 OpenSSL 迁移指南
    - 说明配置差异
    - 说明证书格式转换
    - 添加常见问题

- [ ] 32. 最终检查点 - 文档完整性验证
  - 检查所有文档是否完整
  - 验证代码示例可运行
  - 请用户审查文档
  - 如有问题请询问用户

## 测试配置说明

### 属性测试配置
- 每个属性测试运行 **100 次迭代**
- 使用随机数据生成器生成测试输入
- 每个测试标记对应的设计属性编号和验证的需求

### 测试标记格式
```pascal
// Feature: winssl-server-support, Property 1: 上下文配置往返一致性
// Validates: Requirements 1.3, 1.4, 1.5
procedure TTestWinSSLContext.TestConfigRoundTrip;
```

### TDD 开发流程
1. **红色阶段**: 先编写测试,运行测试(应该失败)
2. **绿色阶段**: 编写最少的代码使测试通过
3. **重构阶段**: 优化代码,保持测试通过

### 可选任务说明
- 标记为 `*` 的子任务是可选的(主要是测试任务)
- 这些任务对于确保代码质量很重要,但可以根据项目进度灵活调整
- 建议优先完成核心实现任务,然后补充测试任务

## 注意事项

1. **遵循 TDD**: 每个实现任务前应先编写对应的测试
2. **增量开发**: 每完成一个阶段就进行验证,不要等到最后
3. **检查点**: 在每个检查点确保所有测试通过再继续
4. **代码审查**: 关键功能实现后请用户审查
5. **性能监控**: 在开发过程中持续监控性能指标
6. **安全优先**: 所有安全相关的功能必须经过严格测试

## 完成标准

- [ ] 所有核心功能实现完成
- [ ] 所有单元测试通过
- [ ] 所有属性测试通过(每个至少 100 次迭代)
- [ ] 所有集成测试通过
- [ ] 与 OpenSSL 后端接口一致
- [ ] 性能指标达标(握手 < 50ms, 并发 100+, 内存 < 100KB/连接)
- [ ] 文档完整且准确
- [ ] 代码示例可运行
- [ ] 通过代码审查

