# fafafa.ssl 编译指南

本文档介绍如何编译 fafafa.ssl 库和示例程序。

---

## 目录

- [系统要求](#系统要求)
- [快速编译](#快速编译)
- [手动编译](#手动编译)
- [常见问题](#常见问题)

---

## 系统要求

### 必需
- **Free Pascal**: 3.2.0 或更高版本
- **OpenSSL**: 1.1.1+ 或 3.x（Linux/macOS）

### 检查安装

```bash
# 检查 Free Pascal
fpc -iV

# 检查 OpenSSL（Linux/macOS）
openssl version

# 检查 OpenSSL 开发包（Linux）
pkg-config --modversion openssl
```

---

## 快速编译

### 使用编译测试脚本

```bash
cd examples
./compile_test.sh
```

这将自动编译所有示例程序并显示结果。

---

## 手动编译

### 1. 编译库（如果作为独立库使用）

```bash
cd src
fpc fafafa.ssl.pas
```

### 2. 编译示例程序

#### 简单HTTPS客户端

```bash
cd examples/production
fpc -Fu../../src https_client_simple.pas
```

#### POST请求示例

```bash
fpc -Fu../../src https_client_post.pas
```

#### 真实网站测试

```bash
cd examples/validation
fpc -Fu../../src real_world_test.pas
```

### 3. 编译简化API演示

```bash
cd examples
fpc -Fu../src simple_https_demo.pas
```

---

## 编译选项说明

### 基本选项

```bash
fpc [选项] 源文件.pas
```

### 常用选项

| 选项 | 说明 |
|------|------|
| `-Fu<路径>` | 添加单元搜索路径 |
| `-Mobjfpc` | 使用Object Pascal模式 |
| `-O2` | 优化级别2 |
| `-Xs` | 静态链接 |
| `-gl` | 生成行信息 |
| `-gh` | 生成堆栈跟踪 |

### 完整编译命令示例

```bash
fpc -Fu../../src \
    -Fu../../src/openssl \
    -Mobjfpc \
    -O2 \
    -Xs \
    https_client_simple.pas
```

---

## 编译配置

### 环境变量

```bash
# 设置单元搜索路径
export FPCDIR=/usr/lib/fpc/3.2.0
export FPC_UNITS=/path/to/fafafa.ssl/src

# 编译时自动包含
fpc -Fu$FPC_UNITS your_program.pas
```

### 配置文件（fpc.cfg）

创建 `fpc.cfg` 文件：

```ini
# fafafa.ssl 单元路径
-Fu/path/to/fafafa.ssl/src

# 输出选项
-O3
-Xs
-XX
```

使用：

```bash
fpc @fpc.cfg your_program.pas
```

---

## 常见问题

### Q1: 找不到 fafafa.ssl 单元

**错误信息**:
```
Fatal: Can't find unit fafafa.ssl used by ...
```

**解决方案**:
```bash
# 方法1: 使用 -Fu 选项
fpc -Fu../../src your_program.pas

# 方法2: 设置环境变量
export FPC_UNITS=/path/to/fafafa.ssl/src
fpc your_program.pas
```

### Q2: OpenSSL 链接错误

**错误信息**:
```
/usr/bin/ld: cannot find -lssl
```

**解决方案**:

Ubuntu/Debian:
```bash
sudo apt-get install libssl-dev
```

CentOS/RHEL:
```bash
sudo yum install openssl-devel
```

macOS:
```bash
brew install openssl@3
export PKG_CONFIG_PATH="/opt/homebrew/opt/openssl@3/lib/pkgconfig"
```

### Q3: 找不到 ProtocolVersionToString 函数

**错误信息**:
```
Error: Identifier not found "ProtocolVersionToString"
```

**解决方案**:
确保使用了正确的单元：

```pascal
uses
  fafafa.ssl,           // 包含 ProtocolVersionToString
  fafafa.ssl.base;      // 或直接使用 base 单元
```

### Q4: 编译速度慢

**解决方案**:
```bash
# 使用优化选项
fpc -O2 -Xs your_program.pas

# 或者禁用调试信息
fpc -Xs your_program.pas
```

### Q5: 静态链接问题

**解决方案**:
```bash
# 静态链接所有库
fpc -Xs -XX your_program.pas

# 仅静态链接系统库
fpc -Xs your_program.pas
```

---

## 交叉编译

### Linux 编译 Windows 程序

```bash
fpc -Twin64 \
    -Fu../../src \
    -Xs \
    your_program.pas
```

### 指定目标架构

```bash
# 64位
fpc -Px86_64 your_program.pas

# 32位
fpc -Pi386 your_program.pas
```

---

## 调试编译

### 启用调试信息

```bash
fpc -g -gl -gh your_program.pas
```

### 使用 GDB 调试

```bash
# 编译时添加调试信息
fpc -g -gl your_program.pas

# 使用 GDB
gdb ./your_program
```

---

## 性能优化编译

### 最高优化

```bash
fpc -O3 -Xs -XX your_program.pas
```

### 优化选项说明

- `-O1`: 基本优化
- `-O2`: 标准优化（推荐）
- `-O3`: 最高优化（可能增加编译时间）
- `-O4`: 最大优化（实验性）

---

## 验证编译结果

### 检查可执行文件

```bash
# 检查文件是否存在
ls -lh your_program

# 检查文件类型
file your_program

# 检查依赖库（Linux）
ldd your_program
```

### 运行测试

```bash
# 运行简单测试
./your_program

# 运行真实网站测试
cd examples/validation
./real_world_test
```

---

## 自动化编译

### 使用 Makefile

创建 `Makefile`:

```makefile
FPC=fpc
FPC_OPTS=-Fu../../src -Mobjfpc -O2 -Xs
SRC_DIR=production
OUT_DIR=bin

all: simple post auth session

simple:
	$(FPC) $(FPC_OPTS) -o$(OUT_DIR)/https_client_simple $(SRC_DIR)/https_client_simple.pas

post:
	$(FPC) $(FPC_OPTS) -o$(OUT_DIR)/https_client_post $(SRC_DIR)/https_client_post.pas

clean:
	rm -f $(OUT_DIR)/* *.o *.ppu

.PHONY: all simple post clean
```

使用:

```bash
make all
```

---

## 下一步

- [快速入门](快速入门.md) - 5分钟上手
- [安装配置](安装配置.md) - 详细配置
- [API参考](API参考/概述.md) - 完整API文档

---

**返回**: [文档首页](快速入门.md) | **上一级**: [安装配置](安装配置.md)



