# fafafa.ssl 安装配置指南

本文档详细介绍 fafafa.ssl 的安装、配置和环境设置。

## 目录
- [系统要求](#系统要求)
- [安装方法](#安装方法)
- [配置编译器](#配置编译器)
- [验证安装](#验证安装)
- [问题排查](#问题排查)

---

## 系统要求

### 操作系统
- ✅ Linux (Ubuntu 20.04+, Debian 11+, CentOS 8+)
- ✅ Windows 10/11
- ✅ macOS 11+

### 编译器
- **Free Pascal**: 3.2.0 或更高
- **Delphi**: 10.3 Rio 或更高

### SSL/TLS 后端
- **Linux**: OpenSSL 1.1.1+ 或 3.x
- **Windows**: WinSSL (内置) 或 OpenSSL
- **macOS**: OpenSSL (推荐通过 Homebrew 安装)

---

## 安装方法

### 方法一：Git 克隆（推荐开发者）

```bash
# 克隆仓库
git clone https://github.com/你的用户名/fafafa.ssl.git
cd fafafa.ssl

# 查看可用版本
git tag -l

# 切换到特定版本（可选）
git checkout v1.0.0
```

### 方法二：下载发布版本

1. 访问 [GitHub Releases](https://github.com/你的用户名/fafafa.ssl/releases)
2. 下载最新版本的源码包
3. 解压到项目目录：

```bash
unzip fafafa.ssl-1.0.0.zip
cd fafafa.ssl-1.0.0
```

### 方法三：添加为子模块（推荐项目集成）

```bash
cd your-project
git submodule add https://github.com/你的用户名/fafafa.ssl.git libs/fafafa.ssl
git submodule update --init --recursive
```

---

## 配置编译器

### Linux 依赖安装

#### Ubuntu/Debian

```bash
# 安装 Free Pascal
sudo apt-get update
sudo apt-get install fpc lazarus

# 安装 OpenSSL 开发包
sudo apt-get install libssl-dev

# 验证安装
fpc -version
openssl version
```

#### CentOS/RHEL

```bash
# 安装 Free Pascal
sudo yum install fpc

# 安装 OpenSSL 开发包
sudo yum install openssl-devel

# 验证安装
fpc -version
openssl version
```

#### macOS

```bash
# 安装 Homebrew（如果未安装）
/bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"

# 安装 Free Pascal 和 OpenSSL
brew install fpc openssl@3

# 添加 OpenSSL 到路径
export PKG_CONFIG_PATH="/opt/homebrew/opt/openssl@3/lib/pkgconfig"

# 验证安装
fpc -version
openssl version
```

### Lazarus IDE 配置

1. **安装包**
   - 打开 Lazarus
   - 包 (Package) → 打开包文件 (.lpk)
   - 选择 `fafafa_ssl.lpk`
   - 点击 "使用 (Use)" → "安装 (Install)"
   - 重新编译 IDE

2. **项目配置**
   - 项目 → 项目选项
   - 编译器选项 → 路径
   - 添加到"其他单元文件路径"：`/path/to/fafafa.ssl/src`

3. **使用单元**
   ```pascal
   uses
     fafafa.ssl, fafafa.ssl.base;
   ```

### Free Pascal 命令行配置

#### 方法 A：环境变量

```bash
# Linux/macOS - 添加到 ~/.bashrc 或 ~/.zshrc
export FPC_UNITS="/path/to/fafafa.ssl/src"
export FPCDIR="/usr/lib/fpc/3.2.0"  # 根据实际路径调整

# 编译时自动包含
fpc -Fu$FPC_UNITS your_program.pas
```

#### 方法 B：配置文件

创建 `fpc.cfg` 在项目目录：

```ini
# fafafa.ssl 单元路径
-Fu/path/to/fafafa.ssl/src

# 输出选项
-O3
-Xs
-XX
```

使用：
```bash
fpc @fpc.cfg your_program.pas
```

#### 方法 C：命令行参数

```bash
fpc -Fu/path/to/fafafa.ssl/src \
    -Fu/usr/lib/fpc/3.2.0/units/x86_64-linux/rtl \
    your_program.pas
```

### Delphi 配置

1. **库路径设置**
   - 工具 (Tools) → 选项 (Options)
   - 语言 (Language) → Delphi → Library
   - Library Path → 添加 `C:\path\to\fafafa.ssl\src`

2. **项目搜索路径**
   - 项目 → 选项
   - Delphi 编译器 → 搜索路径
   - 添加 `$(ProjectDir)..\fafafa.ssl\src`

3. **使用单元**
   ```pascal
   uses
     fafafa.ssl, fafafa.ssl.base;
   ```

---

## 验证安装

### 编译测试程序

创建 `test_install.pas`：

```pascal
program test_install;

{$mode objfpc}{$H+}

uses
  SysUtils, fafafa.ssl;

var
  LContext: ISSLContext;
begin
  try
    WriteLn('测试 fafafa.ssl 安装...');
    
    // 尝试创建 SSL 上下文
    LContext := TSSLFactory.CreateContext(sslOpenSSL, sslCtxClient);
    
    if LContext <> nil then
    begin
      WriteLn('✓ 安装成功！');
      WriteLn('✓ OpenSSL 后端可用');
      ExitCode := 0;
    end
    else
    begin
      WriteLn('✗ 创建上下文失败');
      ExitCode := 1;
    end;
  except
    on E: Exception do
    begin
      WriteLn('✗ 错误: ', E.Message);
      ExitCode := 2;
    end;
  end;
end.
```

编译运行：

```bash
fpc test_install.pas
./test_install
```

预期输出：
```
测试 fafafa.ssl 安装...
✓ 安装成功！
✓ OpenSSL 后端可用
```

### 运行示例程序

```bash
cd examples/production
fpc https_client_simple.pas
./https_client_simple https://www.google.com
```

### 运行真实网站测试

```bash
cd examples/validation
fpc real_world_test.pas
./real_world_test
```

这将测试20个真实HTTPS网站，生成详细报告。

---

## 问题排查

### 问题 1: 找不到 fafafa.ssl 单元

**错误信息**：
```
Fatal: Can't find unit fafafa.ssl used by ...
```

**解决方案**：
1. 检查路径是否正确：
   ```bash
   ls /path/to/fafafa.ssl/src/fafafa.ssl.pas
   ```

2. 确认编译器参数：
   ```bash
   fpc -Fu/path/to/fafafa.ssl/src test.pas
   ```

3. Lazarus 用户：重新编译包并重启 IDE

### 问题 2: OpenSSL 链接错误

**错误信息**：
```
/usr/bin/ld: cannot find -lssl
```

**解决方案**：

Ubuntu/Debian:
```bash
sudo apt-get install libssl-dev
```

CentOS/RHEL:
```bash
sudo yum install openssl-devel
```

验证：
```bash
ldconfig -p | grep libssl
```

### 问题 3: OpenSSL 版本不兼容

**错误信息**：
```
Error loading OpenSSL libraries
```

**解决方案**：
1. 检查 OpenSSL 版本：
   ```bash
   openssl version
   ```

2. 确保版本 >= 1.1.1：
   ```bash
   # Ubuntu
   sudo apt-get install openssl libssl1.1
   
   # 或升级到 OpenSSL 3.x
   sudo apt-get install openssl libssl3
   ```

3. 设置库路径（如果需要）：
   ```bash
   export LD_LIBRARY_PATH=/usr/local/ssl/lib:$LD_LIBRARY_PATH
   ```

### 问题 4: Windows 编译错误

**错误信息**：
```
Can't find WinSock2 unit
```

**解决方案**：
1. 确保使用 Win32/Win64 目标平台
2. 检查 FPC 安装是否完整
3. 重新安装 Free Pascal

### 问题 5: 权限错误

**错误信息**：
```
Permission denied when accessing /var/log/...
```

**解决方案**：
```bash
# 创建日志目录
mkdir -p ~/.fafafa_ssl/logs

# 在程序中使用用户目录
LLogger := TLogger.Create('~/.fafafa_ssl/logs/app.log');
```

### 问题 6: 64位 vs 32位

**错误信息**：
```
Wrong architecture (32-bit/64-bit mismatch)
```

**解决方案**：
```bash
# 明确指定目标架构
fpc -Px86_64 your_program.pas  # 64位
fpc -Pi386 your_program.pas    # 32位

# 或在 Lazarus 中：
# 项目 → 项目选项 → 编译器选项 → 目标平台
```

---

## 高级配置

### 启用调试符号

```bash
fpc -g -gl -gh your_program.pas
```

### 优化编译

```bash
fpc -O3 -Xs -XX your_program.pas
```

### 交叉编译

```bash
# Linux 下编译 Windows 程序
fpc -Twin64 -Fu/path/to/fafafa.ssl/src your_program.pas
```

### 静态链接

```bash
fpc -Xs -XX your_program.pas
```

---

## 下一步

- ✅ 阅读[快速入门](快速入门.md)
- ✅ 查看[API参考](API参考/概述.md)
- ✅ 运行[示例程序](../examples/)
- ✅ 阅读[FAQ](FAQ.md)

---

**上一篇**：[← 快速入门](快速入门.md) | **下一篇**：[第一个应用 →](第一个应用.md)


