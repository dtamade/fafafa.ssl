# OpenSSL实现修复计划

## 当前状态

OpenSSL后端实现已经可以编译，但在创建测试程序时发现了更多运行时需要修复的问题。

## 发现的问题列表

### 1. CRYPTO_free 函数调用错误 (第914行)
**问题**: `CRYPTO_free(LHex);` - 参数数量错误
**原因**: CRYPTO_free在OpenSSL 3.x中可能需要额外的参数
**解决方案**: 检查CRYPTO_free的正确签名，或使用OPENSSL_free替代

### 2. EVP_PKEY_id 未找到 (第992行)
**问题**: 标识符 `EVP_PKEY_id` 未找到
**原因**: 该函数可能在EVP模块中未声明或未导出
**解决方案**: 在EVP API模块中添加EVP_PKEY_id的声明和加载

### 3. EVP_MAX_MD_SIZE 常量未定义 (第1082行)
**问题**: 常量未找到
**原因**: 该常量可能在EVP模块中未定义
**解决方案**: 在EVP API consts模块中添加该常量定义

### 4. EVP哈希函数类型不兼容 (第1090-1094行)
**问题**: EVP_sha256等函数返回类型与PEVP_MD不兼容
**原因**: 这些是函数指针，需要调用才能获取PEVP_MD
**解决方案**: 修改调用方式：`EVP_sha256()` 而不是 `EVP_sha256`

### 5. LoadOpenSSLCore 参数错误 (第1399行)
**问题**: 参数数量错误
**原因**: LoadOpenSSLCore可能不需要参数
**解决方案**: 检查LoadOpenSSLCore的正确签名

### 6. OPENSSL_version 函数使用错误 (第1414, 1422, 1429, 1438行)
**问题**: 函数调用和类型转换错误
**原因**: OPENSSL_version需要调用，不能直接赋值
**解决方案**: 正确调用函数：`OPENSSL_version(type_)`

### 7. RegisterBackend/UnregisterBackend 不存在 (第1522, 1527行)
**问题**: 方法不存在
**原因**: 工厂模式中可能没有这些方法，或者方法名不同
**解决方案**: 使用正确的注册方法名，或删除这些调用

## 修复优先级

### 阶段1: 基础API修复 (高优先级) ✅ 完成
1. ✅ 添加缺失的API模块引用到uses子句
2. ✅ 修复EVP_PKEY_id - 添加EVP_PKEY_id别名
3. ✅ 修复EVP_MAX_MD_SIZE - 添加EVP digest常量定义
4. ✅ 修复CRYPTO_free - 添加OPENSSL_free简化版本

### 阶段2: 函数调用修复 (中优先级) ✅ 完成
5. ✅ 修复EVP哈希函数调用 - 添加括号获取函数指针
6. ✅ 修复OPENSSL_version调用 - 正确处理函数指针和参数
7. ✅ 修复LoadOpenSSL调用 - 简化为调用LoadOpenSSLCore

### 阶段3: 工厂集成修复 (低优先级) ✅ 完成
8. ✅ 修复RegisterLibrary/UnregisterLibrary - 使用正确的工厂方法

## 实施策略

采用**分步验证**策略：

1. **先修复编译错误** - 确保代码能编译通过
2. **创建最小测试** - 只测试基础库加载
3. **逐步扩展测试** - 一个功能一个功能地验证
4. **完善实现** - 根据测试结果完善代码

## 后续步骤

修复完成后：
1. 运行基础验证测试
2. 编写单元测试
3. 完善TODO标记的功能
4. 添加集成测试
5. 编写使用文档和示例

## 时间估算

- 阶段1: 30分钟
- 阶段2: 20分钟  
- 阶段3: 10分钟
- 测试验证: 30分钟
- **总计: 约90分钟**
